import qualified Waterfall
import Linear
import Control.Lens ((^.), (.~))
import Data.Function ((&))
import Waterfall.SVG (parsePath)
import Control.Monad (sequence)
import Data.Either (fromRight)
-- This code makes heavy use of a module called "Waterfall.SVG"
-- I plan on including this into the opencascade-hs monorepo, however need to clean it up first
-- Until I've done so, running this will be moderately difficult

-- print two of these, one of them mirrored, and then glue them back to back
-- to get a more symetrical ornament

goLogo :: Waterfall.Solid
goLogo = 
    let fromPaths = mconcat . fmap (Waterfall.prism 3 . Waterfall.fromPath) .  mconcat . fromRight (error "bad path") . traverse parsePath
        outerPath = ["m 195.51172,11.623047 c -0.0197,0.008 -0.0393,0.01651 -0.0586,0.02539 -0.0194,-0.0069 -0.0389,-0.01342 -0.0586,-0.01953 -32.60889,2.579702 -64.16384,7.639811 -90.49805,20.541016 -9.139367,4.47741 -17.59073,9.98724 -25.275376,16.583983 C 72.241611,44.196098 64.891028,42.03553 57.96875,41.75 c -4.370063,-0.180256 -8.570355,0.384245 -12.5,1.5625 -10.479054,3.142014 -19.026033,10.5593 -24.070312,19.560547 -5.044279,9.001246 -6.60305,19.660506 -2.896485,29.226562 3.347645,8.639741 11.013808,16.236811 23.8125,20.820311 -13.39297,53.3679 -1.305317,104.47394 0.11777,158.23523 -1.959523,-0.0914 -3.940666,-0.0672 -5.921875,0.0781 -8.087599,0.59354 -16.170839,3.18324 -22.728515,7.94726 -2.413285,1.75355 -7.4955972,5.49011 -9.1678299,9.2481 -0.8361164,1.87898 -1.372107,6.92166 -0.9029277,8.91711 0.411825,1.75151 1.7465779,3.26209 3.6699219,4.38476 0.3254517,3.73125 3.0535067,8.78629 4.9928197,10.45179 2.088345,1.79351 4.823595,2.24655 7.535156,1.98829 5.423123,-0.51654 11.206667,-3.68542 14.910156,-6.24415 3.153124,-2.17898 4.940358,-2.19278 6.820313,-3.20312 -2.92109,54.64273 -15.345922,122.99654 14.870323,171.90949 5.01386,8.11664 9.108067,13.94328 15.978325,20.17994 -5.421883,3.97986 -13.454234,8.98727 -18.992188,15.22266 -2.795924,3.14803 -4.470218,7.71439 -5.240793,11.62695 -0.770574,3.91257 1.428049,8.4219 4.186296,12.77514 l 0.08789,0.13672 0.115234,0.11719 c 1.442239,1.45236 2.468476,2.04486 3.419922,2.14453 0.724114,0.0758 0.77552,0.0518 1.013672,0.10937 0.610565,1.11733 1.913468,3.44541 4.572266,5.07617 3.0263,1.85618 9.187419,4.3532 15.085317,0.8463 6.16004,-3.39059 11.178837,-8.29921 16.367188,-12.5371 5.194661,-4.24304 10.497586,-7.79972 17.218746,-8.83985 l 2.49805,-0.38672 3.22071,1.51614 c 24.11574,10.24545 46.38221,11.23979 70.76038,12.11217 29.77842,1.06463 62.75058,-2.02483 91.9961,-12.6582 7.00837,-2.54818 12.29196,-2.97379 18.77658,-6.44109 6.48046,2.52928 12.14701,8.72731 18.55787,15.55437 3.34338,3.56045 8.768,8.50835 12.86672,9.60743 4.02853,1.08026 9.18105,-0.61574 13.71272,-4.6635 l 0.16211,-0.12305 c 0.0246,-0.0224 0.0496,-0.0321 0.0742,-0.0547 4.67773,-2.92139 8.29003,-7.32337 8.60981,-11.49447 0.32583,-4.24995 0.13714,-11.71308 -2.34974,-15.86456 -4.52518,-7.55411 -13.45847,-15.00184 -19.52267,-19.1269 8.09268,-7.99734 13.07904,-14.5737 18.51081,-25.4248 24.84841,-49.63598 20.86497,-108.31979 17.32621,-162.81334 0.68922,0.33696 1.44405,0.76193 2.30859,1.35937 3.7035,2.55873 9.48704,5.72761 14.91016,6.24415 2.71156,0.25826 5.44681,-0.19478 7.53516,-1.98829 1.9393,-1.6655 3.58463,-3.61171 3.91009,-7.34296 1.92313,-1.12267 4.33777,-5.26326 4.74948,-7.01468 0.46909,-1.99547 2.4e-4,-4.02924 -0.83593,-5.9082 -1.67236,-3.75795 -6.15413,-9.2559 -8.56679,-11.00939 -6.55767,-4.76402 -14.64092,-7.35372 -22.72851,-7.94726 -0.84507,-0.062 -1.68973,-0.0945 -2.53321,-0.11328 -2.16574,-55.30604 2.3372,-108.89872 -11.78033,-162.60089 13.1425,-4.97039 20.77121,-13.309571 23.80274,-22.615231 3.16266,-9.708179 1.38479,-20.326925 -3.70508,-29.19336 -5.08986,-8.866433 -13.52143,-16.038476 -23.83789,-18.828125 -2.57912,-0.697411 -5.2722,-1.1164 -8.05469,-1.216796 -8.01115,-0.289055 -16.74979,2.064257 -25.55273,7.951171 C 304.83059,34.319224 293.28873,27.899875 280.83398,23.283203 255.17211,13.770968 225.76567,11.623047 195.51172,11.623047 Z"
            ]
        remove x = (`Waterfall.difference` (Waterfall.translate (unit _z). fromPaths $ x))
        add x = (<>  fromPaths x)
        innerPaths = 
            [ "m 194.27412,24.996004 c 30.08704,0.0032 56.39294,0.173877 81.47234,9.470204 12.29445,4.557254 22.75287,9.531877 32.8449,18.094008 11.59225,22.975592 15.91894,36.181783 29.30988,56.798894 15.44214,65.89273 13.80838,160.12577 13.80838,160.12577 l -4.32158,-0.12584 c 0,0 0.34189,10.96647 0.45624,12.91201 0.1851,3.14863 1.23013,17.11192 1.23013,17.11192 l 5.57221,1.20783 c 0,0 9.92245,109.36214 -14.52581,158.1988 -5.25528,10.4985 -11.6096,18.78181 -19.43574,26.54086 -13.07601,1.58063 -21.95146,9.87794 -28.94699,20.95849 -6.07195,3.18624 -9.73487,4.68813 -16.29624,7.07378 -28.73939,10.44935 -59.36378,13.11183 -88.85528,12.05746 -23.86444,-0.854 -47.27537,-3.62769 -70.77271,-13.47655 C 104.52831,499.69076 94.495481,487.07856 81.888994,489.65532 74.443394,483.21708 69.646908,476.99844 64.361381,468.44202 33.996078,419.28778 53.811692,351.93093 56.059096,296.19854 58.725237,230.07683 34.876079,167.4058 56.293663,103.611 67.382504,70.58292 88.308282,52.680745 114.069,40.060488 139.81559,27.447159 161.8413,27.564618 194.27412,24.996004 Z"
            , "M 337.24023 46.273438 C 332.05023 46.285105 329.06766 47.30623 322.32617 51.796875 L 329.54297 63.849609 C 336.91599 59.952943 343.69384 59.247003 347.86914 67.142578 C 352.38175 75.676387 348.69366 79.610806 341.31641 83.513672 L 348.21289 95.033203 C 360.02106 90.683086 364.01775 87.290705 366.58789 79.400391 C 369.23977 71.259129 366.73707 66.686339 362.35547 59.052734 C 357.97386 51.419131 355.15971 49.782727 346.38672 47.410156 C 344.19347 46.817014 341.98642 46.412716 339.61719 46.322266 C 338.76823 46.289855 337.98166 46.271771 337.24023 46.273438 z"
            , "m 54.580078,49.798828 c -0.669976,0.0069 -1.379634,0.03979 -2.142578,0.0957 -2.129736,0.156079 -4.187661,0.548753 -6.160156,1.140625 -7.889979,2.367486 -12.324542,6.407254 -16.146485,13.232422 -3.821942,6.825168 -6.113689,14.081349 -3.392578,21.109375 2.646885,6.836316 5.157913,10.932575 16.580078,14.378906 1.381086,-5.162369 2.755115,-9.821697 4.248047,-14.085937 -6.496373,-3.439001 -12.256975,-8.421861 -8.283203,-15.941406 5.372022,-6.661196 12.094384,-5.272065 17.205078,-2.404297 3.108978,-4.536822 6.852051,-8.649412 11.578125,-12.628907 -6.017391,-3.706953 -8.796497,-4.944891 -13.486328,-4.896484 z"
            , "m 37.248463,279.03155 c -0.654924,0.003 -1.312037,0.0245 -1.970417,0.0749 -6.444732,0.49319 -12.881233,2.61637 -17.995812,6.43041 -1.619183,1.20768 -4.194803,4.03009 -5.335717,6.66194 -0.570457,1.31591 -0.774347,2.54085 -0.55729,3.48845 0.194052,0.84717 0.188013,0.7583 1.383795,1.43127 1.795431,-0.66713 3.622553,-0.81577 4.540655,-2.07172 2.875904,-1.31054 3.86858,0.21878 3.502989,2.69014 -1.380929,1.88909 -4.689053,3.24917 -6.378475,3.85036 0.264343,2.60785 1.130015,2.8043 2.117576,3.6749 1.103586,0.97288 2.620954,1.29511 4.496465,1.11174 3.751022,-0.36674 8.548708,-2.92659 11.455952,-4.98837 3.055992,-2.16778 5.247254,-2.50827 6.045598,-2.95216 0.399172,-0.22195 0.533867,-0.32576 0.769591,-0.97554 0.23562,-0.64949 0.442737,-1.85351 0.565581,-3.81023 0.307035,-4.91297 0.761719,-9.73656 0.618659,-14.50202 -1.081388,-0.0665 -2.167609,-0.11784 -3.25915,-0.11407 z"
            , "m 365.26347,277.26648 c -0.83434,0.0124 -11.63262,-1.09366 -9.3249,-0.70587 -0.13698,4.4425 0.29841,8.93921 0.59244,13.51922 v 0.002 c 0.11764,1.82433 0.31598,2.94689 0.54161,3.55243 0.22573,0.60581 7.18439,1.51165 7.56665,1.71858 0.76451,0.41386 2.86449,0.73131 5.79096,2.75242 2.78404,1.92228 7.58181,3.4068 10.96884,4.65085 2.93771,1.07901 5.0797,-2.57062 5.0797,-2.57062 0,0 -3.78359,-1.28373 -6.27103,-4.304 -0.50346,-1.73337 3.39118,-4.08985 4.6189,-3.24932 0.88065,1.1729 2.31912,1.64954 4.04224,2.27305 1.14466,-0.62729 1.59953,-1.32312 1.78526,-2.11273 0.2078,-0.88346 0.0127,-2.02553 -0.53368,-3.25242 -1.09266,-2.45381 -3.55931,-5.08518 -5.10957,-6.21119 -4.89781,-3.55598 -11.06312,-5.53552 -17.23472,-5.99532 -0.84058,-0.0627 -1.67836,-0.0791 -2.5127,-0.0667 z"
            , "m 81.277697,501.80489 c -1.079788,-0.0139 -2.21016,0.10024 -3.383188,0.32309 -4.392725,3.21618 -13.289441,9.54505 -17.275921,14.03356 -2.029015,2.28455 -3.486439,4.69815 -3.98013,7.20485 -0.486501,2.4702 -1.021088,3.53151 0.816479,6.48903 1.960979,2.10298 7.471348,-5.41839 8.995747,-8.66381 1.717813,-1.81801 3.43746,1.16931 3.882543,2.506 -1.958015,4.38349 -6.612137,7.59159 -7.145013,11.75576 0.502722,0.89118 0.278603,0.38559 1.761286,1.29498 1.696233,1.04039 4.115709,1.51397 8.264886,-0.96003 l 0.01846,-0.0108 0.01692,-0.009 c 4.483426,-2.46395 8.353698,-6.21542 12.554258,-9.64646 3.733169,-3.04929 10.639035,-8.23372 15.642016,-9.46264 -2.895216,-3.78024 -5.979234,-7.74427 -9.563385,-10.60651 -3.022673,-2.41383 -6.300366,-4.05056 -10.144948,-4.23398 -0.152149,-0.007 -0.30576,-0.0119 -0.460015,-0.0139 z"
            , "m 324.89126,497.86098 c 0,0 -15.21468,7.55138 -20.57064,14.50783 6.51836,2.93855 11.49379,10.52485 16.5966,15.95726 2.77441,2.95364 5.5373,5.22509 8.24753,5.95162 2.52484,0.67684 3.18199,1.00775 6.41296,-1.7002 -2.13391,-4.62279 -4.81945,-8.16721 -8.11237,-11.32745 -1.14902,-1.68922 -1.05786,-3.5734 -0.17194,-4.68857 1.04179,-1.31137 3.1826,-1.55932 5.69813,0.82369 3.86443,3.70875 6.0215,7.71715 7.79964,11.87 2.77167,-2.02514 2.77228,-3.36594 2.96699,-5.90485 0.22116,-2.88384 -0.89998,-6.2044 -2.88791,-9.52192 -3.75515,-7.21893 -9.48556,-11.62496 -15.97899,-15.96741 z"
            ]
        innerPaths' = 
            [ "m 135.63477,45.373047 c -19.00313,-0.670928 -39.264179,7.821343 -49.095222,24.691337 -9.083313,15.833058 -7.842748,37.012326 3.14949,51.609186 11.058332,15.1321 31.373222,21.1197 49.410562,18.16625 18.12214,-2.5478 35.88689,-14.27483 41.74354,-32.17993 5.51519,-17.156137 1.13693,-37.827845 -12.5309,-50.001878 -8.88676,-7.972195 -20.86038,-11.921295 -32.67747,-12.284965 z"
            , "m 258.22266,39.974609 c -20.46742,0.279652 -41.35749,11.881586 -49.63244,31.097276 -4.06779,9.766323 -5.59604,21.118084 -1.9089,31.220215 4.496,14.66858 16.81628,26.33568 31.50548,30.53621 20.45102,6.11486 44.75682,0.8695 59.277,-15.23417 9.96104,-10.89393 12.73141,-26.892752 9.1514,-40.961333 -3.10942,-14.640955 -13.46898,-27.721638 -27.62618,-33.026087 -6.5784,-2.617425 -13.6995,-3.769921 -20.76636,-3.632111 z"
            , "m 182.69336,125.83203 c -3.32849,2.51144 -5.54443,6.46387 -5.78125,10.62695 -7.41639,0.8037 -13.53455,4.86834 -17.92578,10.8205 -3.72999,5.82609 -4.81696,13.28547 -1.07813,19.84961 2.45117,4.30436 5.92455,6.58901 9.71485,7.30859 1.06704,0.20258 2.15213,0.28515 3.24804,0.28516 -1.68267,8.15845 -0.33111,17.754 3.41993,24.19336 2.30046,3.94919 5.78457,6.85234 10.15625,6.76562 4.00505,-0.0794 8.23786,-2.55666 12.7207,-7.83008 2.55166,4.63425 7.16512,7.86681 12.55664,8.6875 l 0.48047,0.0723 0.44531,-0.19531 c 1.76215,-0.77235 3.84855,-1.30314 5.91406,-2.22852 2.06553,-0.92537 4.14156,-2.34464 5.47852,-4.79688 l 0.11914,-0.21874 0.0449,-0.2461 c 1.52673,-8.33506 0.21603,-16.83344 -0.19726,-24.44726 2.82816,0.88432 5.69574,1.44926 8.6289,1.10546 3.36261,-0.39415 6.70665,-2.01802 9.82227,-5.29296 3.45998,-3.63708 4.96222,-7.48188 4.80078,-11.17969 -0.16143,-3.69782 -1.91501,-7.12985 -4.47461,-10.18555 -4.89478,-5.8434 -12.79649,-10.50096 -19.96094,-13.55273 0.27575,-2.72326 -0.76141,-5.60572 -2.45703,-7.73438 -3.72701,-4.68353 -9.8458,-6.60283 -15.61133,-7.07422 -10.50624,-0.5838 -10.62498,-0.4435 -20.06443,5.26737 z"
            ]
        innerPaths'' =
            [ "M 215.82617 142.61719 C 213.24295 144.40169 210.14161 145.50644 207.14453 146.3125 C 200.13391 148.02088 192.61521 148.28695 185.64844 146.23047 C 183.78496 145.65487 181.8506 144.79115 180.26953 143.55859 C 176.84204 144.5896 173.78568 147.03945 171.86133 150.12305 C 169.47472 153.94737 168.83221 158.60319 171.12695 162.73633 C 172.66437 165.506 174.47755 166.65612 176.6543 167.08008 C 178.83105 167.50404 181.44615 167.09297 184.23633 166.30469 C 189.79898 164.73311 195.85222 161.61566 201.13672 162.28906 C 206.87089 162.43348 211.84902 165.34188 216.27734 166.91016 C 218.50238 167.69816 220.55761 168.15043 222.47461 167.91992 C 224.3916 167.6894 226.24501 166.82197 228.24609 164.66406 C 230.47548 162.25988 231.24274 160.04936 231.15234 157.92383 C 231.06188 155.7983 230.06186 153.66832 228.38867 151.61914 C 225.4588 148.03086 220.51766 144.83186 215.82617 142.61719 z"
            , "m 195.46127,168.28245 c -0.385,7.74262 -1.71418,12.90364 -0.80571,20.9721 -3.55333,4.56716 -6.57185,6.2541 -8.78182,6.29939 -2.27245,0.0465 -4.193,-1.46621 -5.75231,-4.23188 -3.03381,-5.38089 -2.49691,-11.95062 -1.14195,-18.27439 5.003,-0.80792 10.94256,-4.16113 16.48179,-4.76522 z"
            , "m 201.8811,168.32244 c 4.73385,-0.55703 9.30414,1.22313 13.80001,4.06658 0.14598,6.6336 1.34555,12.50841 0.24495,19.05577 -0.70679,1.25262 -1.64814,1.95234 -2.8877,2.52726 -1.16386,0.5398 -2.58653,0.96666 -4.01087,1.56557 -3.44372,-0.63417 -6.31922,-2.89444 -7.75907,-6.13601 -0.89515,-7.4138 0.24361,-13.38353 0.61268,-21.07917 z"
            , "m 135.83534,54.466731 c 8.70954,0.294847 15.5793,4.443746 22.56051,9.264476 9.30828,6.427643 12.92958,13.198404 13.81858,28.414199 0.73895,12.653114 -1.19069,17.000324 -8.29599,24.511984 -7.10528,7.51167 -17.04762,12.32151 -27.4904,13.95245 -10.44276,1.63096 -15.94312,1.14725 -24.9817,-3.92888 -9.02898,-5.07071 -15.953876,-10.38003 -19.099633,-22.99041 -3.004593,-15.575554 0.943419,-25.077734 8.312843,-33.894345 7.37453,-8.822724 14.87768,-13.336979 26.45528,-14.891671 2.89441,-0.388672 5.81737,-0.536085 8.72055,-0.437803 z"
            , "m 257.00724,51.036176 c 7.93119,-0.151301 15.77856,1.562813 22.53469,5.290545 9.00816,4.970309 13.40505,9.908289 16.3591,22.596759 3.30099,14.178197 2.32712,20.450515 -4.50979,28.84803 -6.83693,8.39751 -15.48591,13.65908 -26.7546,15.54733 -11.26869,1.88824 -21.07358,1.1457 -30.77274,-4.43971 -9.68119,-5.57508 -16.34924,-10.40279 -18.77948,-24.402793 -1.56657,-25.974877 13.02,-39.001245 34.00112,-42.672381 2.62499,-0.459301 5.27797,-0.717347 7.9217,-0.76778 z"
            ]
        innerPaths''' =
            [ "m 122.153,95.403999 c 0.13354,7.067921 -4.73741,14.206741 -11.81195,15.726051 -10.487977,2.60256 -20.056176,-8.75682 -17.561118,-18.859592 1.108911,-9.678283 12.903998,-16.271843 21.366368,-11.127671 5.04861,2.800999 8.0483,8.556442 8.0067,14.261212 z"
            , "m 231.57031,75.341797 c -12.07875,-0.09856 -18.46427,15.527573 -12.12467,24.986323 4.18047,8.01802 16.13335,9.54585 22.07784,2.81521 6.41982,-6.460801 6.10796,-18.16769 -0.75048,-24.198882 -2.49893,-2.259487 -5.82101,-3.616621 -9.20269,-3.602651 z"
            ]
        innerPaths'''' = 
            [ "m 238.20312,90.947266 c 1.74859,-0.01 3.10397,1.5776 3.36085,3.214104 0.34733,1.795023 -0.42564,3.909491 -2.15898,4.693053 -2.04855,0.966239 -4.38538,-0.918738 -4.57333,-3.028836 -0.41129,-2.156358 0.95108,-4.855577 3.37146,-4.878321 z"
            , "m 117.565,99.028999 c 0.0276,1.714191 -1.02032,3.546991 -2.75287,3.988711 -2.65731,0.67771 -4.73788,-2.36311 -4.17196,-4.785069 0.21984,-2.174722 2.66372,-4.068918 4.76669,-2.974917 1.39844,0.67689 2.16781,2.261345 2.15814,3.771275 z"
            ]
    in fromPaths outerPath
            & remove innerPaths
            & add innerPaths'
            & remove innerPaths''
            & add innerPaths'''
            & remove innerPaths''''
            & Waterfall.scale (V3 0.1 0.1 1)

circle :: Waterfall.Path2D
circle = Waterfall.pathFrom (unit _x)
                [ Waterfall.arcViaTo (unit _y) (negate $ unit _x)
                , Waterfall.arcViaTo (negate $ unit _y) (unit _x)
                ]

ornament :: Waterfall.Solid
ornament = 
    let 
        com = Waterfall.centerOfMass goLogo
        Just (lo, _hi) = Waterfall.axisAlignedBoundingBox goLogo 
        rawHoop = Waterfall.sweep (Waterfall.fromPath2D . Waterfall.uScale2D 3 $ circle) (Waterfall.fromPath circle)
        hoopClipped = rawHoop `Waterfall.intersection` (Waterfall.centeredCube & Waterfall.translate (unit _z ^* 0.5) & Waterfall.uScale 10)
        hoopPositioned = hoopClipped 
            & Waterfall.translate (unit _x ^* (com ^. _x))
            & Waterfall.translate (unit _y ^* (lo ^. _y))
    in hoopPositioned <> goLogo


main :: IO ()
main = do
    Waterfall.writeSTL 0.1 "go-ornament.stl" ornament
